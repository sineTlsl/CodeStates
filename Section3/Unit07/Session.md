## Session이란?

> `Session` 은 서버와 클라이언트의 연결이 활성화 된 상태에서 서버에 데이터를 저장하는 방법을 말한다.

- 서버가 Client에 유일하고 암호화된 ID를 부여한다.
- 중요 데이터는 서버에서 관리한다.

<br>

## 세션기반 인증 (Session-based Authentication)

쇼핑몰 웹 사이트를 예를 들어, 로그인을 통해 사용자의 인증 정보를 저장하고, 그 후 인증된 사용자가 웹 사이트를 이용하고 로그아웃까지 하는 예제를 살펴본다.

### 로그인

1. 사용자가 올바른 아이디와 비밀번호를 입력했을 때, 서버는 인증(Authentication)에 성공했다고 판단한다.
2. 물품을 장바구니에 추가하는 등 인증을 필요로 하는 작업을 수행했을 때, **서버는 해당 유저가 인증에 성공했음을 알고 있어, 유저가 매번 로그인 할 필요가 없다.**

2번은 인증에 따라 리소스의 `접근 권한(Authorization)` 이 달라진다.

> 서버와 클라이언트에게 각각 필요한 것은 다음과 같다.

- **서버**: 사용자가 인증에 성공했음을 알고 있어야 한다.
- **클라이언트**: 인증 성공을 증명할 수단을 갖고 있어야 한다.

**세션**

- 세션은 사용자가 인증에 성공한 상태다.
- 서버는 일종의 저장소에 세션을 저장한다. in-memory(자바스크립트 객체), 또는 세션 스토어(redis 등과 같은 트랜잭션이 빠른 DB)에 저장한다.
- 세션이 만들어지면, 각 세션을 구분할 수 있는 **세션 아이디**도 생성되는데, 보통 클라이언트에 세션 성공을 증명할 수단으로써 세션 아이디를 전달한다.

**이때 웹 사이트에서 로그인을 유지하기 위한 수단으로 쿠키를 사용한다. 쿠키에는 서버에서 발급한 세션 아이디를 저장한다.**

1. 쿠키를 통해 유효한 세션 아이디가 서버에 전달된다.
2. 세션 스토어에 해당 세션이 존재하다면 서버는 해당 요청에 접근 가능하다고 판단한다.

만약, 쿠키에 세션 아이디 정보가 없을 경우, 서버는 해당 요청이 인증되지 않았음을 알려준다.

<br>

### 로그아웃

세션 아이디가 담긴 쿠키는 클라이언트에 저장되어 있으며, 서버는 세션을 저장하고 있다. 그리고 서버는 그저 세션 아이디로만 인증 여부를 판단한다.

> 로그아웃은 다음과 같은 작업을 해야한다.

- **서버**: 세션 정보를 삭제해야 한다.
- **클라이언트**: 쿠키를 갱신하거나 삭제해야 한다.

클라이언트에서 세션정보를 없애기 위해서는 `res.cookie` 로 쿠키의 값을 무효한 값으로 갱신하거나, `res.clearCookie` 로 쿠키를 삭제해버리면 된다.

**\*주의**: 쿠키는 세션 아이디, 즉 인증 성공에 대한 증명을 갖고 있으므로, 탈취될 경우 서버는 해당 요청이 인증된 사용자의 요청이라고 판단한다. (공공 PC에서 로그아웃을 꼭 해야하는 이유)

<br>

## express-session

> `express-session` 는 Node.js에는 이런 세션을 대신 관리해 주는 모듈로 세션을 위한 미들웨어다. `express` 서버에서 쉽게 섹션을 위한 공간을 다룰 수 있도록 만들어준다.

```jsx
const express = require("express");
const session = require("express-session");

const app = express();

app.use(
  session({
    secret: "@codestates",
    resave: false,
    saveUninitialized: true,
    cookie: {
      domain: "localhost",
      path: "/",
      maxAge: 24 * 6 * 60 * 10000,
      sameSite: "none",
      httpOnly: false,
      secure: true,
    },
  })
);
```

1. `express-session` 를 사용해 위와 같이 세션의 옵션을 지정할 수 있다. 쿠키 옵션과 비슷해보이지만, 다른점은 `secret` 옵션의 비밀키를 사용하여 암호화해 세션 id를 생성한다.

2. 생성한 세션 id를 클라이언트에게 쿠키로 전송하고, 전송된 세션 id는 이에 종속되는 고유한 세션 객체를 가지며, 이는 서버에 저장된다.
   > - 세션 객체는 유저별로 독립적으로 생성된 객체이므로 유저별로 각각 다른 데이터를 저장할 수 있다.
   > - 따라서 클라이언트에 유저의 개인정보를 담지않고도 서버가 클라이언트의 세션 id를 이용해 유저의 인증여부를 판단할 수 있다.
3. 세션 객체는 `req.session` 으로 접근할 수 있으며, 세션이 임의 데이터를 저장하거나 불러올 수 있다.

<br>

> **Reference**
> [CODESTATES (SEB_FE_43)](https://www.codestates.com/)
